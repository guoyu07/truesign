use Royal\Validator\ParamValidator_CLI;
use Royal\Validator\ParamRule;

class AppBaseController extends \ReInit\YafBase\Controller
{
    public function init()
    {
        $this->doInit();
    }

    public function doInit()
    {

    }
    public function getParams(array $required, array $optional = array(), \Royal\Data\DAOAdapter &$adapter = null)
    {

        $paramRules = $adapter ? $adapter->paramRules() : array();
        $rules = $this->getRules($required, $optional, $paramRules);

        $request = $this->getRequest();
//
//        $params = ParamValidator_CLI::paramsFromRequestAndRules($request, $rules);
        $params = \Royal\Validator\ParamValidator_ALL::paramsFromRequestAndRules($request, $rules);
//
        return $params;
    }
    private function getRules(array $required, array $optional, array $paramRules)
    {
        $rules = array();
        $paramNames = array_merge($required, $optional);
        foreach ($paramNames as $r) {
            $rule = ParamRule::rule($r);
            if (isset($paramRules[$r])) {
                $rule = $paramRules[$r];
            }
            $rule->required(in_array($r, $required));
            $param = $this->getRequest()->get($rule->name);
            if (in_array($r, $optional)) {

                if ($param !== null) {
                    $rules[$r] = $rule;
                }
            } else {
                $rules[$r] = $rule;
            }
        }
        return $rules;
    }
    protected function inputErrorResult($code)
    {
        $desc = ErrorCode::errorMsgByCode($code);
//        $desc = $model->getErrorText($code);
        $this->inputError($code, $desc);
    }
    protected  function output2json($result){
        echo json_encode($result);
    }

    protected function inputError($code, $msg)
    {
        $start_exec_time = \Yaf_Registry::get('START_EXEC_TIME');
        $start_exec_memory = \Yaf_Registry::get('START_EXEC_MEMORY');


        $exec=[
            'execTime'=>\Royal\Util\helper::exeTime($start_exec_time),
            'runMem'=>\Royal\Util\helper::run_mem($start_exec_memory)
        ];
        echo json_encode(array('code' => $code, 'desc' => $msg,'exec'=>$exec));
        \Yaf_Dispatcher::getInstance()->autoRender(FALSE);
    }




    public function setResponseBody($data){
        $helper = new \Royal\Util\helper();
//        $rev=$helper::getBody($data, $info, $code);

        if(IS_CLI) {
//            $response = $this->getResponse();
//            $response->contentBody = $rev;
            $response = $this->getResponse();

//            $request = $this->getRequest();
//            $response_data['datatype']=gettype($rev);
//            $response_data['response_data']=$rev;
            $response->contentBody=$data;
        }else{
            $start_exec_time = \Yaf_Registry::get('START_EXEC_TIME');
            $start_exec_memory = \Yaf_Registry::get('START_EXEC_MEMORY');
            $rev['argv']=$this->getData();
            $rev['serv']=[
                'execTime'=>xeTime($start_exec_time),
                'runMem'=>un_mem($start_exec_memory)
            ];
//            r($rev);
        }
        return $rev;
    }
    public function setErr($e,$method,$code=500){
        $this->setBody($e->getMessage(), $method, $code);
    }
    public function getData(){
        try {
            $req = $this->getRequest();
            $raw = $req->getParams();
            if (IS_CLI) {
                return $raw;
            }

            $m = $req->getModuleName();
            $c = $req->getControllerName();
            $a = $req->getActionName();
            $f = APPLICATION_PATH . '/_data/' . $m . '/' . $c . '.php';
            $n = $raw['data'] ?? 'def';
            require_once($f);
            $data = \IndexData::getData($a, $n);
            return $data;
        }catch (\Exception $e){
            throw $e;
        }
    }
    public function getTaskId(){
        return $this->getRequest()->task_id;
    }

    public function getRedis($node){
        return \publics::getRedis($node);
    }
    public function getDB($node){
        return \publics::getDB($node);
    }

    protected function getPageParams() {
        $pageRules = array(
            'page'=>ParamRule::rule('page')->type('int')->defaultValue(1),
            'page_size'=>ParamRule::rule('page_size')->type('int')->defaultValue(10),
        );

        $request = $this->getRequest();
        $params = ParamValidator_CLI::paramsFromRequestAndRules($request, $pageRules);
        if ($params['page'] <= 0) {
            $params['page'] = 1;
        }

        return $params;
    }

//    protected function inputIdResult($id) {
//        $this->inputResult(array('id' => $id));
//    }

    protected function inputParamErrorResult() {
        echo json_encode(array('code' => -100, 'desc' => 'ç¼ºå°‘å‚æ•°æˆ–è€…å‚æ•°éæ³•ï¼'));

        \Yaf_Dispatcher::getInstance()->autoRender(FALSE);
    }

//    protected function inputResult($data = array()) {
//        echo json_encode(array('data' => $data, 'code' => 0));
//        \Yaf_Dispatcher::getInstance()->autoRender(FALSE);
//    }

    public function setParam($key, $type, $value, &$param) {
        if($type == 'in') {
            if(empty($value)) {
                $value = array('0');
            }
        }
        //            $suffixMap = array('le'=>'ä»¥ä¸‹', 'lt'=>'ä»¥ä¸‹', 'ge'=>'ä»¥ä¸Š', 'gt'=>'ä»¥ä¸Š');
        $param[$key] = array(
            'operation' => $type,
            'value' => $value
        );
    }

    protected function _forward($action, $controller = '', $parameters = array()) {
        $this->forward('Index', $controller, $action, $parameters);
    }

    protected function render($tpl, array $parameters = null) {
        $this->display($tpl, $parameters);
    }

    public function sendMail($toemail='137847127@qq.com',$toname='137847127@qq.com',$title='æµ‹è¯•',$content='hi')
    {

//        $toemail = 'xxx@qq.com';//å®šä¹‰æ”¶ä»¶äººçš„é‚®ç®±

        $mail = new PHPMailer();

        $mail->isSMTP();// ä½¿ç”¨SMTPæœåŠ¡
        $mail->CharSet = "utf8";// ç¼–ç æ ¼å¼ä¸ºutf8ï¼Œä¸è®¾ç½®ç¼–ç çš„è¯ï¼Œä¸­æ–‡ä¼šå‡ºç°ä¹±ç 
        $mail->Host = "smtp.iamsee.com";// å‘é€æ–¹çš„SMTPæœåŠ¡å™¨åœ°å€
        $mail->SMTPAuth = true;// æ˜¯å¦ä½¿ç”¨èº«ä»½éªŒè¯
        $mail->Username = "root@iamsee.com";// å‘é€æ–¹çš„163é‚®ç®±ç”¨æˆ·åï¼Œå°±æ˜¯ä½ ç”³è¯·163çš„SMTPæœåŠ¡ä½¿ç”¨çš„163é‚®ç®±</span><span style="color:#333333;">
        $mail->Password = "Zhuotong.936";// å‘é€æ–¹çš„é‚®ç®±å¯†ç ï¼Œæ³¨æ„ç”¨163é‚®ç®±è¿™é‡Œå¡«å†™çš„æ˜¯â€œå®¢æˆ·ç«¯æˆæƒå¯†ç â€è€Œä¸æ˜¯é‚®ç®±çš„ç™»å½•å¯†ç ï¼</span><span style="color:#333333;">
//        $mail->SMTPSecure = "ssl";// ä½¿ç”¨sslåè®®æ–¹å¼</span><span style="color:#333333;">
//        $mail->Port = 994;// 163é‚®ç®±çš„sslåè®®æ–¹å¼ç«¯å£å·æ˜¯465/994

        $mail->setFrom("root@iamsee.com","iamsee.com");// è®¾ç½®å‘ä»¶äººä¿¡æ¯ï¼Œå¦‚é‚®ä»¶æ ¼å¼è¯´æ˜ä¸­çš„å‘ä»¶äººï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºä¸ºMailer(xxxx@163.comï¼‰ï¼ŒMaileræ˜¯å½“åšåå­—æ˜¾ç¤º
        $mail->addAddress($toemail,$toname);// è®¾ç½®æ”¶ä»¶äººä¿¡æ¯ï¼Œå¦‚é‚®ä»¶æ ¼å¼è¯´æ˜ä¸­çš„æ”¶ä»¶äººï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºä¸ºLiang(yyyy@163.com)
//        $mail->addReplyTo("xxx@163.com","Reply");// è®¾ç½®å›å¤äººä¿¡æ¯ï¼ŒæŒ‡çš„æ˜¯æ”¶ä»¶äººæ”¶åˆ°é‚®ä»¶åï¼Œå¦‚æœè¦å›å¤ï¼Œå›å¤é‚®ä»¶å°†å‘é€åˆ°çš„é‚®ç®±åœ°å€
        //$mail->addCC("xxx@163.com");// è®¾ç½®é‚®ä»¶æŠ„é€äººï¼Œå¯ä»¥åªå†™åœ°å€ï¼Œä¸Šè¿°çš„è®¾ç½®ä¹Ÿå¯ä»¥åªå†™åœ°å€(è¿™ä¸ªäººä¹Ÿèƒ½æ”¶åˆ°é‚®ä»¶)
        //$mail->addBCC("xxx@163.com");// è®¾ç½®ç§˜å¯†æŠ„é€äºº(è¿™ä¸ªäººä¹Ÿèƒ½æ”¶åˆ°é‚®ä»¶)
        //$mail->addAttachment("bug0.jpg");// æ·»åŠ é™„ä»¶


        $mail->Subject = $title;// é‚®ä»¶æ ‡é¢˜
        $mail->Body = $content;// é‚®ä»¶æ­£æ–‡
        //$mail->AltBody = "This is the plain textçº¯æ–‡æœ¬";// è¿™ä¸ªæ˜¯è®¾ç½®çº¯æ–‡æœ¬æ–¹å¼æ˜¾ç¤ºçš„æ­£æ–‡å†…å®¹ï¼Œå¦‚æœä¸æ”¯æŒHtmlæ–¹å¼ï¼Œå°±ä¼šç”¨åˆ°è¿™ä¸ªï¼ŒåŸºæœ¬æ— ç”¨

        if(!$mail->send()){// å‘é€é‚®ä»¶
//            echo "Message could not be sent.";
//            echo "Mailer Error: ".$mail->ErrorInfo;// è¾“å‡ºé”™è¯¯ä¿¡æ¯
            return 0;
        }else{
//            echo 'å‘é€æˆåŠŸ';
            return 1;
        }

    }

//    public function getParams(array $required, array $optional, DAOAdapter $adapter = null) {
//        $paramRules = $adapter ? $adapter->paramRules() : array();
//        $rules = $this->getRules($required, $optional, $paramRules);
//        $request = $this->getRequest();
//        return ParamValidator_CLI::paramsFromRequestAndRules($request, $rules);
//    }

//    public function getRequiredParams(array $required, DAOAdapter $adapter = null) {
//        return $this->getParams($required, array(), $adapter);
//    }
//
//    public function getOptionalParams(array $optional, DAOAdapter $adapter = null) {
//        return $this->getParams(array(), $optional, $adapter);
//    }

//    public function getPairParams(array $paramNames, DAOAdapter $adapter = null) {
//        $paramRules = $adapter ? $adapter->paramRules() : array();
//        $rules = $this->getRules(array(), $paramNames, $paramRules);
//        $request = $this->getRequest();
//        return ParamValidator_CLI::pairParamsFromRequestAndRules($request, $rules);
//    }


}